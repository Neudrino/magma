# Copyright 2022 The Magma Authors.
#
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: "Build VM Development"

on:
  pull_request:
    types: [ opened, reopened, synchronize ]
  push: null

jobs:
  packer:
    runs-on: macos-12
    steps:

      - run: |
          tee packer.json << EOF
          {
            "builders": [
              {
              "type": "virtualbox-iso",
              "guest_os_type": "Ubuntu_64",
              "iso_url": "http://releases.ubuntu.com/12.04/ubuntu-12.04.5-server-amd64.iso",
              "iso_checksum": "md5:769474248a3897f4865817446f9a4a53",
              "ssh_username": "packer",
              "ssh_password": "packer",
              "shutdown_command": "echo 'packer' | sudo -S shutdown -P now",
              "post_shutdown_delay": "2m",
              "headless": true,
              "vboxmanage": [
                  [ "startvm", "{{.Name}}", "--type", "headless" ]
                ]
              }
            ]
          }

      - uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # pin@v3

      - name: Packer validate
        run: packer validate -syntax-only test.json
        working-directory: orc8r/tools/packer
      - name: Packer build
        run: packer build -on-error=abort test.json
        working-directory: orc8r/tools/packer

      - name: Fix Template
        uses: hashicorp/packer-github-actions@master
        with:
          command: fix
          target: test.json
          working_directory: orc8r/tools/packer

      - name: Validate Template
        uses: hashicorp/packer-github-actions@master
        with:
          command: validate
          arguments: -syntax-only
          target: test.json
          working_directory: orc8r/tools/packer

      - name: Build Artifact
        uses: hashicorp/packer-github-actions@master
        with:
          command: build
          arguments: "-on-error=abort"
          target: test.json
          working_directory: orc8r/tools/packer
        env:
          PACKER_LOG: 1
